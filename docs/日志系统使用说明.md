# 日志系统使用说明

## 简介

本项目的日志系统基于Python标准库的logging模块，并针对Flask应用进行了优化配置。系统支持多种日志级别、文件轮转以及访问日志记录。

## 日志文件说明

日志文件存储在项目根目录下的 `logs` 文件夹中：

- `app.log` - 应用程序主要日志文件
- `error.log` - 专门记录错误信息
- `access.log` - 记录HTTP请求访问信息

## 日志级别

日志系统支持以下标准日志级别（从低到高）：

1. DEBUG - 详细的调试信息
2. INFO - 一般信息
3. WARNING - 警告信息
4. ERROR - 错误信息
5. CRITICAL - 严重错误信息

## 配置选项

在 `.env` 文件中可以配置以下日志相关选项：

```env
# 日志级别 (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO

# 单个日志文件最大大小（字节）
# 默认为10MB (10 * 1024 * 1024)
LOG_FILE_MAX_BYTES=10485760

# 日志文件备份数量
LOG_FILE_BACKUP_COUNT=10

# 访问日志文件备份数量（按天轮转）
ACCESS_LOG_FILE_BACKUP_COUNT=30
```

## 在代码中使用日志

### 1. 导入日志记录器

在需要记录日志的Python文件中，首先导入日志记录器：

```python
import logging

# 获取当前模块的日志记录器
logger = logging.getLogger(__name__)
```

### 2. 记录不同级别的日志

```python
# 记录调试信息
logger.debug("这是调试信息")

# 记录一般信息
logger.info("操作成功完成")

# 记录警告信息
logger.warning("这是一个警告")

# 记录错误信息
try:
    # 一些可能出错的操作
    risky_operation()
except Exception as e:
    logger.error(f"操作失败: {str(e)}", exc_info=True)

# 记录严重错误
logger.critical("系统遇到严重问题")
```

### 3. 记录异常信息

使用 `exc_info=True` 参数可以记录完整的异常堆栈信息：

```python
try:
    some_operation()
except Exception as e:
    logger.error(f"执行操作时发生错误: {str(e)}", exc_info=True)
```

## 日志格式说明

### 应用日志格式

应用日志采用以下格式：
```
[时间] [日志级别] [模块名] [日志消息]
```

示例：
```
2024-01-15 10:30:45,123 INFO app.services.diagnosis_service 诊断处理完成
```

### 访问日志格式

访问日志采用以下格式：
```
[时间] [客户端IP] [请求URL] [HTTP状态码] [响应时间(秒)]
```

示例：
```
2024-01-15 10:30:45,123 127.0.0.1 http://localhost:5000/api/diagnosis/submit 200 0.125000
```

## 文件轮转机制

### 应用日志和错误日志

采用大小轮转机制：
- 当日志文件达到配置的最大大小时，会创建新的日志文件
- 保留指定数量的备份文件
- 最旧的日志文件会被自动删除

### 访问日志

采用时间轮转机制：
- 每天午夜自动创建新的日志文件
- 保留指定天数的日志文件
- 过期的日志文件会被自动删除

## 最佳实践

### 1. 合理使用日志级别

```python
# 不要记录过多的调试信息到生产环境
if app.debug:
    logger.debug("详细调试信息")

# 正确记录业务流程
logger.info(f"开始处理诊断请求，ID: {diagnosis_id}")

# 及时记录错误
try:
    process_data()
except ValueError as e:
    logger.error(f"数据处理失败: {str(e)}")
```

### 2. 避免记录敏感信息

```python
# 不要记录密码等敏感信息
# 错误示例
logger.info(f"用户登录: {username}, 密码: {password}")

# 正确示例
logger.info(f"用户登录: {username}")
```

### 3. 使用结构化日志

```python
# 记录结构化信息便于后续分析
logger.info("诊断完成", extra={
    'diagnosis_id': diagnosis_id,
    'patient_name': patient_name,
    'processing_time': processing_time
})
```

## 故障排除

### 1. 日志文件未生成

检查：
- 确认 `logs` 目录是否有写入权限
- 确认应用是否有足够权限创建文件

### 2. 日志级别不正确

检查：
- `.env` 文件中的 `LOG_LEVEL` 配置
- 确认没有在代码中覆盖日志级别

### 3. 日志文件过大

检查：
- 调整 `LOG_FILE_MAX_BYTES` 和 `LOG_FILE_BACKUP_COUNT` 配置
- 检查是否有过多的调试日志被记录
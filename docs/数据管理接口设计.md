# 联邦学习平台数据管理接口文档

## 基础信息

- **基础URL**: `/api/v1/federated-data`
- **请求格式**: JSON
- **响应格式**: JSON
- **认证方式**: Bearer Token

## 通用响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

## 1. 新增数据接口

### 接口说明

创建新的联邦学习数据记录

### 请求信息

- **URL**: `POST /api/v1/federated-data`
- **Content-Type**: `application/`

### 请求参数

```json
{
  "caseDescription": "患者男性，35岁，有持续咳嗽、低热黄痰、胸部疼痛、疑似肺结核。",
  "imageUrl": "https://oss.example.com/images/001.jpg"
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "数据创建成功",
  "data": {
    "dataId": 1,
    "caseDescription": "患者男性，35岁，有持续咳嗽、低热黄痰、胸部疼痛、疑似肺结核。",
    "imageUrl": "https://oss.example.com/images/001.jpg",
    "uploadTime": "2024-01-15 13:08:00",
    "dataStatus": "pending"
  }
}
```

## 2. 删除数据接口

### 接口说明

软删除数据记录

### 请求信息

- **URL**: `DELETE /api/v1/federated-data/{dataId}`
- **Content-Type**: `application/json`

### 路径参数

- `dataId`: 数据ID

### 响应示例

```json
{
  "code": 200,
  "message": "数据删除成功",
  "data": null
}
```

## 3. 查询所有数据（分页）

### 接口说明

获取数据列表，支持分页

### 请求信息

- **URL**: `GET /api/v1/federated-data`
- **Content-Type**: `application/json`

### 查询参数

| 参数名   | 类型 | 必须 | 说明             |
| -------- | ---- | ---- | ---------------- |
| page     | int  | 否   | 页码，默认1      |
| pageSize | int  | 否   | 每页大小，默认10 |

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "dataId": 1,
        "thumbnail": "https://oss.example.com/thumb/001.jpg",
        "caseDescription": "患者男性，35岁，有持续咳嗽、低热黄痰、胸部疼痛、疑似肺结核。",
        "uploadTime": "2024-01-15 13:08:00",
        "dataStatus": "approved"
      },
      {
        "dataId": 2,
        "thumbnail": "https://oss.example.com/thumb/002.jpg",
        "caseDescription": "患者女性，28岁，X光显示双肺有斑点，既往患肺病史。",
        "uploadTime": "2024-01-15 11:24:00",
        "dataStatus": "approved"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 10,
      "totalCount": 3,
      "totalPages": 1
    }
  }
}
```

## 4. 根据病情描述模糊查询

### 接口说明

根据病情描述进行模糊搜索

### 请求信息

- **URL**: `GET /api/v1/federated-data/search`
- **Content-Type**: `application/json`

### 查询参数

| 参数名   | 类型   | 必须 | 说明             |
| -------- | ------ | ---- | ---------------- |
| keyword  | string | 是   | 搜索关键词       |
| page     | int    | 否   | 页码，默认1      |
| pageSize | int    | 否   | 每页大小，默认10 |

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "dataId": 1,
        "thumbnail": "https://oss.example.com/thumb/001.jpg",
        "caseDescription": "患者男性，35岁，有持续咳嗽、低热黄痰、胸部疼痛、疑似肺结核。",
        "uploadTime": "2024-01-15 13:08:00",
        "dataStatus": "approved"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 10,
      "totalCount": 1,
      "totalPages": 1
    }
  }
}
```

## 5. 根据时间范围查询

### 接口说明

根据上传时间范围查询数据

### 请求信息

- **URL**: `GET /api/v1/federated-data/by-time`
- **Content-Type**: `application/json`

### 查询参数

| 参数名    | 类型   | 必须 | 说明                       |
| --------- | ------ | ---- | -------------------------- |
| startTime | string | 是   | 开始时间，格式：yyyy-MM-dd |
| endTime   | string | 是   | 结束时间，格式：yyyy-MM-dd |
| page      | int    | 否   | 页码，默认1                |
| pageSize  | int    | 否   | 每页大小，默认10           |

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "dataId": 1,
        "thumbnail": "https://oss.example.com/thumb/001.jpg",
        "caseDescription": "患者男性，35岁，有持续咳嗽、低热黄痰、胸部疼痛、疑似肺结核。",
        "uploadTime": "2024-01-15 13:08:00",
        "dataStatus": "approved"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "pageSize": 10,
      "totalCount": 1,
      "totalPages": 1
    }
  }
}
```

## 6. 更新数据接口

### 接口说明

更新数据信息

### 请求信息

- **URL**: `PUT /api/v1/federated-data/{dataId}`
- **Content-Type**: `application/json`

### 路径参数

- `dataId`: 数据ID

### 请求参数

```json
{
  "caseDescription": "更新后的病情描述",
  "imageUrl": "https://oss.example.com/images/updated/001.jpg"
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "数据更新成功",
  "data": {
    "dataId": 1,
    "caseDescription": "更新后的病情描述",
    "imageUrl": "https://oss.example.com/images/updated/001.jpg",
    "updatedAt": "2024-01-15 11:30:00"
  }
}
```

## 7. 上传图片到阿里云OSS

### 接口说明

上传图片文件到阿里云OSS并返回URL

### 请求信息

- **URL**: `POST /api/v1/upload/image`
- **Content-Type**: `multipart/form-data`

### 请求参数

| 参数名   | 类型   | 必须 | 说明                                       |
| -------- | ------ | ---- | ------------------------------------------ |
| file     | file   | 是   | 图片文件                                   |
| dataType | string | 是   | 图片类型：chest_xray, chest_ct, mri, other |

### 响应示例

```json
{
  "code": 200,
  "message": "文件上传成功",
  "data": {
    "imageUrl": "https://bucket.oss-cn-beijing.aliyuncs.com/images/2024/01/15/abc123.jpg",
    "thumbnailUrl": "https://bucket.oss-cn-beijing.aliyuncs.com/thumbnails/2024/01/15/abc123_thumb.jpg",
  }
}
```

## 错误码说明

| 错误码 | 说明           |
| ------ | -------------- |
| 200    | 成功           |
| 400    | 请求参数错误   |
| 401    | 未授权         |
| 404    | 资源不存在     |
| 500    | 服务器内部错误 |

## 更新后的数据库表设计

```sql
-- 简化后的数据管理表
CREATE TABLE federated_data (
    data_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '数据ID',
    thumbnail VARCHAR(500) COMMENT '缩略图URL',
    image_url VARCHAR(500) NOT NULL COMMENT '原始图片URL',
    case_description TEXT NOT NULL COMMENT '病情描述',
    data_type ENUM('chest_xray', 'chest_ct', 'mri', 'other') DEFAULT 'chest_xray' COMMENT '图片类型',
    upload_time TIMESTAMP NOT NULL COMMENT '上传时间',
    data_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending' COMMENT '数据状态',
    is_deleted TINYINT DEFAULT 0 COMMENT '软删除标记(0-正常,1-删除)',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='联邦学习数据管理表';

-- 创建索引
CREATE INDEX idx_upload_time ON federated_data(upload_time);
CREATE INDEX idx_data_type ON federated_data(data_type);
CREATE FULLTEXT INDEX idx_case_description ON federated_data(case_description);
```

## 数据库操作SQL参考

```sql
-- 新增数据
INSERT INTO federated_data (case_description, data_type, image_url, thumbnail, upload_time) 
VALUES (?, ?, ?, ?, ?);

-- 删除数据
UPDATE federated_data SET is_deleted = 1 WHERE data_id = ?;

-- 查询分页数据
SELECT data_id, thumbnail, case_description, data_type, upload_time, data_status
FROM federated_data 
WHERE is_deleted = 0 
ORDER BY upload_time DESC 
LIMIT ? OFFSET ?;

-- 模糊查询
SELECT data_id, thumbnail, case_description, data_type, upload_time, data_status
FROM federated_data 
WHERE is_deleted = 0 
AND case_description LIKE CONCAT('%', ?, '%')
ORDER BY upload_time DESC 
LIMIT ? OFFSET ?;

-- 时间范围查询
SELECT data_id, thumbnail, case_description, data_type, upload_time, data_status
FROM federated_data 
WHERE is_deleted = 0 
AND DATE(upload_time) BETWEEN ? AND ?
ORDER BY upload_time DESC 
LIMIT ? OFFSET ?;

-- 更新数据
UPDATE federated_data 
SET case_description = ?, data_type = ?, image_url = ?, updated_at = NOW()
WHERE data_id = ? AND is_deleted = 0;
```

这样的设计完全移除了患者隐私信息，只保留病情描述和图片相关信息，符合联邦学习的数据隐私保护要求。